##########################################################################################
#      ___           ___       ___       ___                       ___           ___     #
#     /\  \         /\__\     /\__\     /\__\          ___        /\__\         /\  \    #
#    /::\  \       /:/  /    /:/  /    /::|  |        /\  \      /::|  |       /::\  \   #
#   /:/\:\  \     /:/  /    /:/  /    /:|:|  |        \:\  \    /:|:|  |      /:/\:\  \  #
#  /::\~\:\  \   /:/  /    /:/  /    /:/|:|__|__      /::\__\  /:/|:|  |__   /::\~\:\  \ #
# /:/\:\ \:\__\ /:/__/    /:/__/    /:/ |::::\__\  __/:/\/__/ /:/ |:| /\__\ /:/\:\ \:\__\#
# \/__\:\/:/  / \:\  \    \:\  \    \/__/~~/:/  / /\/:/  /    \/__|:|/:/  / \:\~\:\ \/__/#
#      \::/  /   \:\  \    \:\  \         /:/  /  \::/__/         |:/:/  /   \:\ \:\__\  #
#      /:/  /     \:\  \    \:\  \       /:/  /    \:\__\         |::/  /     \:\ \/__/  #
#     /:/  /       \:\__\    \:\__\     /:/  /      \/__/         /:/  /       \:\__\    #
#     \/__/         \/__/     \/__/     \/__/                     \/__/         \/__/    #
##########################################################################################

Bootstrap: docker
From: ubuntu:18.04

%labels

  Author Thomas_Bersez
  Institution INRA-GAFL_2019_France
  License MIT
  Version v1.0
  Contact thomasbersez@gmail.com

%help

  AllMine, a flexible pipeline for Allele Mining.
  Please read documentation to get help !

  # This software is under the MIT License         #
  # Copyright Thomas Bersez  2019                  #
  # INRA-GAFL / Paris Saclay university            #
  # contact: thomasbersez@gmail.com                #

%environment

  # Default Locales
  export LC_ALL=C

  #Paths
  export PATH="/opt/conda/bin:/usr/local/bin:/usr/bin:/bin:"
  export PATH=~/anaconda3/bin:$PATH
  export PATH=/snpEff:$PATH

  # Conda environement with dependancies for AllMine
  /conda.sh activate AllMine

%post

  # Install git and wget for in-container downloads
  apt-get update
  apt-get install -y git
  apt-get install -y wget
  apt-get install -y unzip

  # Install fastqc and samtools
  apt-get install -y fastqc
  apt-get install -y samtools


  # Install Snakemake for workflow management
  apt-get install -y python3
  apt install -y python3-pip
  pip3 install snakemake

  # Install conda for AllMine dependancies download
  wget https://sourceforge.net/projects/snpeff/files/snpEff_latest_core.zip/download
  unzip download -d /
  rm -rf /clinEff
  /usr/bin/wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  /bin/chmod +x Miniconda3-latest-Linux-x86_64.sh
  echo '\n yes \n' | ./Miniconda3-latest-Linux-x86_64.sh
  chmod +x /root/miniconda3/etc/profile.d/conda.sh
  mv /root/miniconda3/etc/profile.d/conda.sh ./
  ./conda.sh create -y -n ./AllMine.env
  ./conda.sh activate ./AllMine.env



  # Install AllMine dependancies
  ./conda.sh install -c -y bioconda fastp \
  bwa \
  varscan \
  samtools \
  star
  /usr/bin/git clone https://github.com/tbersez/Allmine.git
